# Среда исполнения заданий

Задания {{ ds-jobs }} выполняются на выделенных виртуальных машинах, не связанных с {{ jlab }}Lab и запущенным проектом. Рабочее окружение этих ВМ развертывается на основе [Docker-образа](docker.md) и дополнительных параметров, которые вы определяете в файле конфигурации задания. 

Задания позволяют запускать на виртуальной машине Python-скрипты, Bash-скрипты и любые бинарные файлы, скомпилированные под платформу Linux x86_64. 

## Python-окружение {#python-env}

{% note tip %}

Старайтесь запускать задания в [виртуальном окружении Python](https://docs.python.org/3.10/library/venv.html), чтобы четко контролировать все параметры запуска.

{% endnote %}

### Автоматический сбор окружения Python {#auto}

{% include [jobs-info](../../../_includes/datasphere/jobs-environment.md) %}

Если вы запускаете Python-скрипты, {{ ml-platform-name }} может автоматически подготовить окружение для вашего задания. Для этого укажите параметр `python: auto` в секции `env`:

```yaml
cmd: python main.py <аргументы_вызова>
env:
  python: auto
```

В автоматическом режиме {{ ml-platform-name }} проанализирует зависимости скрипта задания, определит пакеты pip и локальные модули, перенесет все на ВМ, установит и подготовит среду для запуска задания.

Автоматически собранное окружение можно модифицировать:

```yaml
cmd: python main.py <аргументы_вызова>
env:
  python:
    type: auto # указываем автоматический сбор окружения
    root-path:
      - other.py
    pip:
      extra-index-urls:
        - https://pypi.ngc.nvidia.com
      trusted-hosts:
        - nvidia.com
      no-deps: true  # По умолчанию false
```

Где:

* `root-path` — явное указание [дополнительных точек входа](#entry-points).
* `extra-index-urls` — [дополнительные адреса репозиториев](https://pip.pypa.io/en/stable/cli/pip_install/#install-extra-index-url), из которых менеджер пакетов pip сможет установить необходимые пакеты окружения.
* `trusted-hosts` — [список доверенных хостов](https://pip.pypa.io/en/stable/cli/pip/#cmdoption-trusted-host) позволяет обращаться к хостам, перечисленным в формате `<хост>:<порт>`, даже если они не поддерживают HTTPS.
* `no-deps` — [аргумент](https://pip.pypa.io/en/stable/cli/pip_install/#cmdoption-no-deps) команды `pip install`, запрещающий установку зависимостей пакетов.

### Ручное задание окружения Python {#manual}

При настройке окружения Python вручную вы можете явно задать версию Python, указать зависимости и параметры работы pip через файл `requirements.txt` и передать локальные модули. При ручном задании окружения вы должны указать как минимум один параметр. Если параметр не указан в файле конфигурации, его значение будет определено автоматически.

```yaml
env:
 python:
   type: manual     # указываем ручное управление окружением
   version: 3.10.13 # optional
   requirements-file: requirements.txt  # optional
   local-paths:     # optional, нельзя использовать с опцией root-paths
     - foo.py
     - lib/
```

Где:

* `version` — версия Python. Если не указано, используется версия окружения, из которого запускается задание.
* `requirements-file` — путь к файлу `requirements.txt`, в котором перечислены все пакеты и флаги pip, необходимые для задания. Если не указано, список зависимостей будет определен автоматически.
* `local-paths` — список локальных Python-файлов, которые нужно перенести. С его помощью можно указывать не только конечные файлы, но и целые директории. Если не указано, список файлов будет определен автоматически. 

### Явное указание точек входа {#entry-points}

{% note warning %}

Используйте [стандартную конструкцию](https://docs.python.org/3/library/__main__.html) `if __name__ == "__main__":` в своих программах для **всех** точек входа. 

{% endnote %}

Вы можете запускать Python-скрипты в заданиях различными способами:
* явно запускать скрипт через `python main.py <arguments>`.
* использовать готовые стартеры сторонних производителей, например [deepspeed](https://pypi.org/project/deepspeed/): `deepspeed main.py --num_gpus=1 --deepspeed_stage 2 --apply_lora True`.
* передавать программы как аргументы при запуске других программ: `python main.py other.py`.

Чтобы собрать окружение и запустить задание, {{ ml-platform-name }} необходимо будет определить все точки входа в программу. Если это не удастся сделать в автоматическом режиме, укажите их в файле конфигурации `config.yaml`:

```yaml
env:
  python:
    type: auto | manual   # возможны оба варианта
    root-paths:           # optional, нельзя использовать с опцией local-paths
      - main.py
      - other.py
```

## Plain-окружение {#plain-env}

По умолчанию в заданиях используется Plain-окружение для исполнения бинарных файлов и Bash-скриптов. В этом случае на ВМ будут перенесены все файлы, указанные в секции `inputs` файла конфигурации задания.

### Пример {#bash-example}

Выполнение следующего задания выведет версию ядра Linux, список всех установленных пакетов и список файлов и каталогов домашней директории ВМ.

В файл конфигурации `config.yaml` указана точка входа и список всех модулей, которые нужно передать на ВМ:

```yaml
cmd: ./run.sh
inputs:
  - run.sh  # явно прописываем все необходимые модули
```

В файле с кодом задания `run.sh` перечислены команды, которые нужно выполнить на ВМ:

```bash
#!/bin/bash
uname -a
dpkg -l
ls -la
```


#### Смотри также {#see-also}

* [{#T}](index.md).
* [{#T}](cli.md).
* [{#T}](docker.md).
* [{#T}](../../operations/projects/work-with-jobs.md).
* [GitHub-репозиторий](https://github.com/yandex-cloud-examples/yc-datasphere-jobs-examples) с примерами для запуска заданий.